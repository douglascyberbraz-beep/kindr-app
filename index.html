<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>KINDR - Stop Searching. Start Living.</title>

    <!-- Fonts: Inter for premium look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRS9BMY=" crossorigin="" />

    <!-- App CSS -->
    <link rel="stylesheet" href="css/main.css?v=11.2.0">

    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002C77">
    <link rel="apple-touch-icon" href="assets/logo.svg">
</head>

<body>
    <div id="app">
        <!-- Splash Screen -->
        <div id="splash-screen" class="splash-screen">
            <div class="logo-container">
                <img src="assets/logo.svg" alt="Kindr Logo" class="splash-logo">
            </div>
            <div id="v-tag"
                style="position:absolute; bottom:20px; font-size:10px; opacity:0.5; color:var(--primary-dark);">Build:
                v11.2.0 (Formatted)</div>
        </div>

        <!-- Main Content Area -->
        <main id="main-content" class="hidden">
            <!-- Dynamic Content (News, Events, etc.) -->
        </main>

        <!-- Persistent Map Container v11 -->
        <div id="map-viewport-v11"
            style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10; background: white; display: none;">
            <!-- New Map lives here -->
        </div>

        <!-- Bottom Navigation with Smooth Centering -->
        <nav id="bottom-nav" class="bottom-nav hidden">
            <button class="nav-item" data-page="news">
                <span class="icon">‚ú®</span>
                <span class="label">News</span>
            </button>
            <button class="nav-item" data-page="events">
                <span class="icon">üéà</span>
                <span class="label">Events</span>
            </button>
            <button class="nav-item" data-page="tribu">
                <span class="icon">üèòÔ∏è</span>
                <span class="label">Tribu</span>
            </button>

            <button class="nav-item active" data-page="map">
                <div class="map-orb">
                    <span class="icon home-icon">üó∫Ô∏è</span>
                </div>
            </button>

            <button class="nav-item" data-page="ranking">
                <span class="icon">üåü</span>
                <span class="label">Top</span>
            </button>
            <button class="nav-item" data-page="chat">
                <span class="icon">ü§ñ</span>
                <span class="label">IA</span>
            </button>
            <button class="nav-item" data-page="profile">
                <span class="icon">üç≠</span>
                <span class="label">M√≠</span>
            </button>
        </nav>

        <!-- Login/Register Modal -->
        <div id="auth-modal" class="modal hidden">
            <!-- Auth content -->
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- QRCode JS (Simple implementation via CDN if needed, or mock image for now) -->

    <!-- Firebase SDKs (Compat version for simple file protocol execution) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- App Configuration (Must be loaded after Firebase SDKs) -->
    <script src="js/config.js"></script>

    <!-- App Services & Pages (Order matters) -->
    <script src="js/services/data.js"></script>
    <script src="js/services/auth.js"></script>
    <script src="js/pages/map_v11.js"></script>
    <script src="js/pages/tribu.js"></script>
    <script src="js/pages/ranking.js"></script>
    <script src="js/pages/news.js"></script>
    <script src="js/pages/events.js"></script>
    <script src="js/pages/chat.js"></script>
    <script src="js/pages/profile.js"></script>

    <!-- Main App Logic -->
    <script src="js/app.js"></script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Nuclear cleanup command for the user if needed
                window.forceResetApp = () => {
                    localStorage.clear();
                    caches.keys().then(names => {
                        for (let name of names) caches.delete(name);
                    });
                    navigator.serviceWorker.getRegistrations().then(regs => {
                        for (let reg of regs) reg.unregister();
                    });
                    setTimeout(() => window.location.reload(true), 500);
                };

                navigator.serviceWorker.register('sw.js?v=10.0.0').then(reg => {
                    console.log('Service Worker v10.0.0 registrado');

                    // Detect updates and reload
                    reg.addEventListener('updatefound', () => {
                        const newWorker = reg.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available, reload to apply
                                window.location.reload();
                            }
                        });
                    });
                }).catch(err => console.log('Error al registrar SW', err));
            });

            // Handle controller change (claim)
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    window.location.reload();
                    refreshing = true;
                }
            });
        }
    </script>
</body>

</html>